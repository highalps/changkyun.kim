<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>몽고디비 페이징과 룩업 성능 - changkyun.kim</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="mobile-web-app-capable" name="mobile-web-app-capable" content="yes"><meta data-n-head="ssr" data-hid="apple-mobile-web-app-title" name="apple-mobile-web-app-title" content="changkyun.kim"><meta data-n-head="ssr" data-hid="author" name="author" content="comfuture"><meta data-n-head="ssr" data-hid="theme-color" name="theme-color" content="#fff"><meta data-n-head="ssr" data-hid="og:type" name="og:type" property="og:type" content="website"><meta data-n-head="ssr" data-hid="og:title" name="og:title" property="og:title" content="changkyun.kim"><meta data-n-head="ssr" data-hid="og:site_name" name="og:site_name" property="og:site_name" content="changkyun.kim"><meta data-n-head="ssr" data-hid="og:description" name="og:description" property="og:description" content="logs"><meta data-n-head="ssr" data-hid="description" name="description" content="몽고디비 aggregation을 페이징 할 때 성능 문제 해결기
"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" data-hid="material-icon-css" rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"><link data-n-head="ssr" data-hid="prism-theme" rel="stylesheet" href="/css/prism-synthwave84.css"><link data-n-head="ssr" rel="manifest" href="/_nuxt/manifest.1dea7bcc.json"><link data-n-head="ssr" rel="shortcut icon" href="/_nuxt/icons/icon_64.5f6a36.png"><link data-n-head="ssr" rel="apple-touch-icon" href="/_nuxt/icons/icon_512.5f6a36.png" sizes="512x512"><link rel="preload" href="/_nuxt/runtime.343d384.js" as="script"><link rel="preload" href="/_nuxt/node_modules/commons.c46341a.js" as="script"><link rel="preload" href="/_nuxt/app.9cff7de.js" as="script"><link rel="preload" href="/_nuxt/pages/article/_.ceebc4b.js" as="script"><link rel="preload" href="/_nuxt/node_modules/article.~article.index.a6ee544.js" as="script"><style data-vue-ssr-id="38dfa7e4:0 24677ef3:0 3191d5ad:0 757226ae:0 d2fa4c9e:0">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}code{font-family:monospace,monospace;font-size:1em}img{border-style:none}button{font-family:inherit;font-size:100%;line-height:1.15;margin:0;overflow:visible;text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}[hidden],template{display:none}blockquote,h1,h2,h3,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}ol,ul{list-style:none;margin:0;padding:0}html{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid #e2e8f0}hr{border-top-width:1px}img{border-style:solid}[role=button],button{cursor:pointer}h1,h2,h3{font-size:inherit;font-weight:inherit}a{text-decoration:inherit}a,button{color:inherit}button{padding:0;line-height:inherit}code,pre{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}img,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}.bg-transparent{background-color:transparent}.bg-white{--bg-opacity:1;background-color:#fff;background-color:rgba(255,255,255,var(--bg-opacity))}.bg-gray-100{--bg-opacity:1;background-color:#f7fafc;background-color:rgba(247,250,252,var(--bg-opacity))}.bg-gray-200{--bg-opacity:1;background-color:#edf2f7;background-color:rgba(237,242,247,var(--bg-opacity))}.bg-blue-100{--bg-opacity:1;background-color:#ebf8ff;background-color:rgba(235,248,255,var(--bg-opacity))}.bg-purple-100{--bg-opacity:1;background-color:#faf5ff;background-color:rgba(250,245,255,var(--bg-opacity))}.border-transparent{border-color:transparent}.border-gray-300{--border-opacity:1;border-color:#e2e8f0;border-color:rgba(226,232,240,var(--border-opacity))}.border-gray-400{--border-opacity:1;border-color:#cbd5e0;border-color:rgba(203,213,224,var(--border-opacity))}.border-gray-600{--border-opacity:1;border-color:#718096;border-color:rgba(113,128,150,var(--border-opacity))}.border-purple-200{--border-opacity:1;border-color:#e9d8fd;border-color:rgba(233,216,253,var(--border-opacity))}.rounded-sm{border-radius:.125rem}.rounded{border-radius:.25rem}.rounded-md{border-radius:.375rem}.rounded-lg{border-radius:.5rem}.rounded-full{border-radius:9999px}.border-solid{border-style:solid}.border{border-width:1px}.border-l-8{border-left-width:8px}.cursor-pointer{cursor:pointer}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.hidden{display:none}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-between{justify-content:space-between}.flex-grow{flex-grow:1}.float-right{float:right}.font-semibold{font-weight:600}.font-bold{font-weight:700}.h-6{height:1.5rem}.text-xs{font-size:.75rem}.text-sm{font-size:.875rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.leading-none{line-height:1}.leading-relaxed{line-height:1.625}.list-none{list-style-type:none}.mx-2{margin-left:.5rem;margin-right:.5rem}.my-16{margin-top:4rem;margin-bottom:4rem}.mx-auto{margin-left:auto;margin-right:auto}.ml-2{margin-left:.5rem}.mt-4{margin-top:1rem}.mr-4{margin-right:1rem}.mt-16{margin-top:4rem}.mt-32{margin-top:8rem}.-mt-48{margin-top:-12rem}.object-cover{-o-object-fit:cover;object-fit:cover}.focus\:outline-none:focus{outline:0}.p-2{padding:.5rem}.p-4{padding:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.px-3{padding-left:.75rem;padding-right:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.py-8{padding-top:2rem;padding-bottom:2rem}.pr-0{padding-right:0}.pt-16{padding-top:4rem}.static{position:static}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.top-0{top:0}.right-0{right:0}.shadow-md{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}.fill-current{fill:currentColor}.text-gray-600{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.text-gray-700{--text-opacity:1;color:#4a5568;color:rgba(74,85,104,var(--text-opacity))}.uppercase{text-transform:uppercase}.underline{text-decoration:underline}.invisible{visibility:hidden}.whitespace-no-wrap{white-space:nowrap}.w-6{width:1.5rem}.w-1\/2{width:50%}.w-10\/12{width:83.333333%}.w-full{width:100%}.z-50{z-index:50}.transition-all{transition-property:all}@media (min-width:640px){.sm\:mt-0{margin-top:0}.sm\:px-0{padding-left:0;padding-right:0}.sm\:w-6\/12{width:50%}}@media (min-width:768px){.md\:block{display:block}.md\:flex{display:flex}.md\:hidden{display:none}.md\:flex-row{flex-direction:row}.md\:justify-start{justify-content:flex-start}.md\:mt-48{margin-top:12rem}.md\:mt-64{margin-top:16rem}.md\:ml-auto{margin-left:auto}.md\:p-4{padding:1rem}.md\:px-32{padding-left:8rem;padding-right:8rem}.md\:pr-4{padding-right:1rem}.md\:static{position:static}.md\:w-64{width:16rem}.md\:w-auto{width:auto}.md\:w-1\/2{width:50%}.md\:w-8\/12{width:66.666667%}}@media (min-width:1024px){.lg\:py-8{padding-top:2rem;padding-bottom:2rem}.lg\:px-48{padding-left:12rem;padding-right:12rem}.lg\:w-6\/12{width:50%}}@media (min-width:1280px){.xl\:w-6\/12{width:50%}}code[class*=language-],pre[class*=language-]{color:#f92aad;text-shadow:0 0 2px #100c0f,0 0 5px rgba(220,7,142,.2),0 0 10px hsla(0,0%,100%,.2);font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:transparent!important;background-image:linear-gradient(180deg,#2a2139 75%,#34294f)}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#fff;z-index:999999}.page-enter-active,.page-leave-active{transition:opacity .35s}.page-enter,.page-leave-to{opacity:0}.topnav{position:fixed;z-index:50;width:100%;--bg-opacity:1;background-color:#fff;background-color:rgba(255,255,255,var(--bg-opacity));top:0;display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:.75rem .5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}.topnav .brand{font-size:.875rem;font-weight:700;line-height:1.625;display:inline-block;margin-right:1rem;padding-top:.5rem;padding-bottom:.5rem;white-space:nowrap;text-transform:uppercase;--text-opacity:1;color:#2d3748;color:rgba(45,55,72,var(--text-opacity))}.topnav .hamburger{cursor:pointer;font-size:1.25rem;line-height:1;padding:.25rem .75rem;border:1px solid transparent;border-radius:.25rem;background-color:transparent;outline:0}.topnav .menu-item{padding:.5rem .75rem;display:flex;align-items:center;font-size:.75rem;text-transform:uppercase;font-weight:700;--text-opacity:1;color:#2d3748;color:rgba(45,55,72,var(--text-opacity))}.leading,.topnav .menu-item:hover{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.leading{margin-top:1rem;font-size:1.125rem;line-height:1.625}article.article{margin-left:.5rem;margin-right:.5rem;margin-bottom:1.5rem}@media (min-width:768px){article.article{margin-left:0;margin-right:0}}article.article header h1{--text-opacity:1;color:#4a5568;color:rgba(74,85,104,var(--text-opacity));font-weight:600;font-size:1.5rem;margin-bottom:.5rem}@media (min-width:768px){article.article header h1{font-size:2.25rem}}article.article header h2{--text-opacity:1;color:#4a5568;color:rgba(74,85,104,var(--text-opacity));font-weight:600;font-size:1.25rem;margin-bottom:.5rem}@media (min-width:768px){article.article header h2{font-size:1.5rem}}article.article header p.meta{min-height:2em}article.article header p.meta .created-at{float:right;--text-opacity:1;color:#a0aec0;color:rgba(160,174,192,var(--text-opacity))}.nuxt-content h1{--text-opacity:1;color:#4a5568;color:rgba(74,85,104,var(--text-opacity));font-weight:600;font-size:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}@media (min-width:768px){.nuxt-content h1{font-size:2.25rem}}.nuxt-content h2{--text-opacity:1;color:#4a5568;color:rgba(74,85,104,var(--text-opacity));font-weight:600;font-size:1.25rem;margin-top:1rem;margin-bottom:1rem}@media (min-width:768px){.nuxt-content h2{font-size:1.5rem}}.nuxt-content blockquote{border-left-width:8px;--border-opacity:1;border-color:#e2e8f0;border-color:rgba(226,232,240,var(--border-opacity));padding-left:1.5rem}.nuxt-content p{--text-opacity:1;color:#4a5568;color:rgba(74,85,104,var(--text-opacity));padding-top:.5rem;padding-bottom:.5rem;line-height:1.625}.nuxt-content p>code{border-width:1px;--border-opacity:1;border-color:#e9d8fd;border-color:rgba(233,216,253,var(--border-opacity));border-radius:.125rem;--bg-opacity:1;background-color:#faf5ff;background-color:rgba(250,245,255,var(--bg-opacity));padding-left:.5rem;padding-right:.5rem}.nuxt-content a{text-decoration:underline;--text-opacity:1;color:#3182ce;color:rgba(49,130,206,var(--text-opacity))}.nuxt-content ul{margin-left:1rem}.nuxt-content ul li{list-style-type:disc}.nuxt-content ol{list-style-type:decimal;margin-left:1rem}.nuxt-content a.footnote-ref{text-decoration:none;--text-opacity:1;color:#4a5568;color:rgba(74,85,104,var(--text-opacity));border-width:1px;--border-opacity:1;border-color:#cbd5e0;border-color:rgba(203,213,224,var(--border-opacity));--bg-opacity:1;background-color:#ebf8ff;background-color:rgba(235,248,255,var(--bg-opacity));border-radius:9999px;padding-left:.5rem;padding-right:.5rem}.nuxt-content .footnotes{padding-top:1.5rem;padding-bottom:1.5rem}.nuxt-content .footnotes hr{display:none}.nuxt-content .footnotes li{position:absolute;display:inline-block;border-width:1px;--border-opacity:1;border-color:#cbd5e0;border-color:rgba(203,213,224,var(--border-opacity));--bg-opacity:1;background-color:#f7fafc;background-color:rgba(247,250,252,var(--bg-opacity));padding:.5rem;border-radius:.375rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);width:100%}.nuxt-content .footnotes li .invisible{opacity:0}@media (min-width:768px){.nuxt-content .footnotes li{width:50%}}.nuxt-content .footnotes li a.footnote-backref{display:none}.nuxt-content-highlight{font-size:.75rem;margin-top:1.5rem;margin-bottom:1.5rem}@media (min-width:768px){.nuxt-content-highlight{font-size:1rem}}.nuxt-content-highlight>.filename{--text-opacity:1;color:#718096;color:rgba(113,128,150,var(--text-opacity))}.nuxt-content-highlight>.filename:before{font-family:"Material Icons";font-weight:400;font-style:normal;font-size:20px;line-height:1em;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;-webkit-font-feature-settings:"liga";-webkit-font-smoothing:antialiased;content:"code";margin:0 .5em}.nuxt-content-highlight>pre{border-radius:.375rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><header><nav class="topnav"><div class="container px-4 sm:px-0 mx-auto flex flex-wrap items-center justify-between"><div class="w-full relative flex justify-between md:w-auto md:static md:block md:justify-start"><a href="/" class="brand nuxt-link-active">Changkyun Kim</a> <button type="button" class="hamburger md:hidden block focus:outline-none"><span class="material-icons">dehaze</span></button></div> <div class="transition-all md:flex flex-grow items-center hidden"><ul class="flex flex-col md:flex-row list-none md:ml-auto"><li><a href="/about" class="menu-item"><i class="material-icons">face</i><span class="ml-2">About</span></a></li> <li><a href="/article" class="menu-item nuxt-link-active"><i class="material-icons">subject</i><span class="ml-2">Articles</span></a></li> <li><a href="https://github.com/comfuture/changkyun.kim" target="_blank" class="menu-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current w-6 h-6"><title>GitHub</title> <path d="M10 0a10 10 0 0 0-3.16 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94 0-1.1.39-1.99 1.03-2.69a3.6 3.6 0 0 1 .1-2.64s.84-.27 2.75 1.02a9.58 9.58 0 0 1 5 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69 0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0 0 10 0"></path></svg> <span class="ml-2">Github</span></a></li> <li><a href="/contact" class="menu-item"><i class="material-icons">contact_mail</i><span class="ml-2">Contact</span></a></li></ul></div></div></nav></header> <div class="md:px-32 lg:px-48 mx-auto container mt-32"><article class="article"><header><h1>
      몽고디비 페이징과 룩업 성능
    </h1> <p class="meta"><span class="created-at"><i class="material-icons">access_time</i>Aug 11, 2020
</span></p></header> <div class="nuxt-content"><p>몽고디비는 도큐먼트DB 특성상 기존 RDBMS와는 데이터를 다루는 철학에 차이가 조금 있다.</p>
<p>이번에 회사 프로덕트를 만들면서 여러 컬렉션을 참조하는 목록을 페이징하는 쿠에리에서 심각하게 성능저하가 일어나는 것을 발견하여 이를 해결하는 과정을 소개한다.</p>
<p>우선, 페이징을 구현하기 위해서는 전체 컬렉션 또는 커서의 일부분만 잘라내어 fetch 해줄 방법이 필요하다.
몽고디비에는 <code>.skip()</code> 과 <code>.limit()</code> 체인메소드를 기본 제공하기 때문에 이 부분에는 문제가 없다.</p>
<p>하지만 총 몇 page가 존재하는지(또는 이전/다음 페이지가 존재하는지)를 알기 위해서는 커서의 총 도큐먼트 수를 알아내야 할 필요가 있다.
과거 3.x 이전 버전에서는 우선 cursor를 만든다음 클론하여 하나는 도큐먼트 수를 세는데, 하나는 커서의 일부를 잘라내는데 사용했었다.</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-js"><code>mongo<span class="token operator">></span> <span class="token keyword">var</span> cursor <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token property-access">contents</span><span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
mongo<span class="token operator">></span> <span class="token keyword">var</span> total <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token method function property-access">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
mongo<span class="token operator">></span> cursor<span class="token punctuation">.</span><span class="token method function property-access">skip</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> itemPerPage<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">limit</span><span class="token punctuation">(</span>itemPerPage<span class="token punctuation">)</span>
</code></pre></div>
<h2 id="페이징할-문서-전체의-갯수-가져오기"><a href="#%ED%8E%98%EC%9D%B4%EC%A7%95%ED%95%A0-%EB%AC%B8%EC%84%9C-%EC%A0%84%EC%B2%B4%EC%9D%98-%EA%B0%AF%EC%88%98-%EA%B0%80%EC%A0%B8%EC%98%A4%EA%B8%B0" aria-hidden="true" tab-index="-1"><span class="icon icon-link"></span></a>페이징할 문서 전체의 갯수 가져오기</h2>
<p>4.x 부터는 <code>cursor.count()</code> 메소드 사용을 지양하고 <code>collection.countDocuments(query)</code> 또는 <code>collection.estimatedDocumentCount(query)</code> 를 대신 사용할 것을 권장할 뿐 아니라, 일부 드라이버에서는 이미 <code>cursor.count()</code> 메소드가 deprecate 되어있다. 여기에는 함정이 숨어있는데, 단순 <code>collection.find()</code>가 아닌 aggregation의 경우에는 해당되지 않는다는 점이다.</p>
<p>aggregation을 페이징 하려면 <code>AggregationPipeline.count()</code> 를 조회하는 대신 pipeline의 일정 단계 이후 스테이지를 분기하여 각각 <code>도큐먼트 수</code> 및 <code>페이징된 커서</code> 를 얻는데 사용해야 한다.
스테이지를 여러개로 분리하는데는 <code>$facet</code> 스테이지를 활용하면 한번의 오퍼레이션으로 두가지 정보를 한꺼번에 가져올 수 있다.</p>
<p>(여기서부터는 헬퍼 코드를 작성했기 때문에, mongo shell 대신 각종 언어 드라이버 기준으로...)</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-python"><code><span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">PagedAggregation</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    page<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span>
    page_size<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span>
    total<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>
    items<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span> <span class="token operator">=</span> field<span class="token punctuation">(</span>default_factory<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Generator<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>items

    <span class="token keyword">def</span> <span class="token function">__json__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token string">'page'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>page<span class="token punctuation">,</span>
            <span class="token string">'pageSize'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>page_size<span class="token punctuation">,</span>
            <span class="token string">'total'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>total<span class="token punctuation">,</span>
            <span class="token string">'totalPages'</span><span class="token punctuation">:</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>self<span class="token punctuation">.</span>total <span class="token operator">/</span> self<span class="token punctuation">.</span>page_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'items'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>items
        <span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">paged</span><span class="token punctuation">(</span>collection<span class="token punctuation">:</span> Collection<span class="token punctuation">,</span> pipeline<span class="token punctuation">:</span> List<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> page<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> page_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> PagedAggregation<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    generates an aggregation facet pipeline, then fetch
    """</span>
    pager <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'$facet'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'metadata'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token string">'$count'</span><span class="token punctuation">:</span> <span class="token string">'total'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span><span class="token string">'$addFields'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'page'</span><span class="token punctuation">:</span> page<span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'items'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token string">'$skip'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> page_size<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span><span class="token string">'$limit'</span><span class="token punctuation">:</span> page_size<span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span>

    paged_pipeline <span class="token operator">=</span> pipeline<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    paged_pipeline<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pager<span class="token punctuation">)</span>
    doc <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>collection<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>paged_pipeline<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> PagedAggregation<span class="token punctuation">(</span>
        page<span class="token operator">=</span>page<span class="token punctuation">,</span>
        page_size<span class="token operator">=</span>page_size<span class="token punctuation">,</span>
        total<span class="token operator">=</span>doc<span class="token punctuation">[</span><span class="token string">'metadata'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'total'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        items<span class="token operator">=</span>doc<span class="token punctuation">[</span><span class="token string">'items'</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
</code></pre></div>
<p>구글링과 스택넘침질로 얻은 각종 스킬들을 조합하여 나름 꽤 심플하고 합리적으로 aggregate의 페이징을 정리한 듯 했다<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>.
하지만 문서 수가 수십만을 넘기 시작하면서, 파이프라인에서 다른 컬렉션을 $lookup 하는 빈도가 늘어나면서 성능이 심각할 정도로 나빠지기 시작했다.</p>
<p>개인적으로는 실행 계획(explain)을 눈으로 짐작하기 쉽지 않은 SQL보다 각 단계에서 할 일을 순차적으로 명시하는 aggregation pipeline 쪽이 훨씬 낫다고 생각했었다.
물론 그 사실에는 변함이 없지만, 데이터를 "관계"로 바라보는 RDBMS와 다르게 "도큐먼트"로 바라보는 몽고디비의 철학에서 내가 원하는 "결과"만을 목적으로 파이프라인을 짜다보면 자신이 놓은 함정에 걸리게 되는 경우가 생긴다.</p>
<p>위에 작성한 <code>paged</code> 헬퍼를 이용하여 평균 20여개의 코멘트가 달린 100만건의 블로그 글 목록에서 내가 작성한 글의 일부 페이지를 가져오려고 한다면,</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-python"><code>pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span><span class="token string">'$match'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'author_id'</span><span class="token punctuation">:</span> me
  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">'$lookup'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'from'</span><span class="token punctuation">:</span> <span class="token string">'comments'</span><span class="token punctuation">,</span>
    <span class="token string">'localField'</span><span class="token punctuation">:</span> <span class="token string">'_id'</span><span class="token punctuation">,</span>
    <span class="token string">'foreignField'</span><span class="token punctuation">:</span> <span class="token string">'article_id'</span><span class="token punctuation">,</span>
    <span class="token string">'as'</span><span class="token punctuation">:</span> <span class="token string">'comments'</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>

paged<span class="token punctuation">(</span>db<span class="token punctuation">.</span>articles<span class="token punctuation">,</span> pipeline<span class="token punctuation">,</span> page<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> page_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre></div>
<p>이런 식이 될 것이다.</p>
<p><code>$lookup</code> 스테이지가 <code>$skip</code>, <code>$limit</code> 스테이지보다 앞서 등장하기 때문에 10개의 도큐먼트를 얻기 전에 100만건 article 모두에 대한 comment 를 미리 lookup 하게 되어, 사실상 문서마다 20개의 댓글을 포함하여 총 2000만개의 도큐먼트를 조회한 후 그중 일부를 가져오게 된다.
aggregation pipeline은 메모리상에서 최대 100MB만 사용할 수 있는 제약사항이 있기 때문에 스테이지의 일부 단계에서 문서 갯수가 많거나 메모리를 초과할 것으로 예상된다면 미리 <code>allowDiskUse</code> 옵션을 활성화 시켜 두지 않았다면 최종 10개 문서(x20개 댓글)를 가져오기 전에 이미 메모리 부족 에러를 만날 가능성도 있다.</p>
<p>위 예시의 경우는 페이징을 마치 RDBMS의 <code>LIMIT n, m</code> 으로 다루듯 마지막 단계에만 페이징을 위한 스테이지를 추가하는 경우를 보여주는 예시로, 몽고디비에서 쉽게 저지를 수 있는 실수에 해당한다.
<code>$lookup</code> 스테이지를 직접 <code>$limit</code> 스테이지 다음으로 옮겨두면 극적으로 성능 향상을 기대할 수 있다.</p>
<p><code>$lookup</code>된 외래 도큐먼트의 속성을 <code>$match</code> 스테이지에서 활용하고자 하는 경우엔 이야기가 달라진다.</p>
<blockquote>
<p>19세 미만 미성년자가 작성한 글과 댓글을 가져오려는 경우..</p>
</blockquote>
<div class="nuxt-content-highlight"><pre class="line-numbers language-python"><code>pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span><span class="token string">'$lookup'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'from'</span><span class="token punctuation">:</span> <span class="token string">'author'</span><span class="token punctuation">,</span>
    <span class="token string">'localField'</span><span class="token punctuation">:</span> <span class="token string">'author_id'</span><span class="token punctuation">,</span>
    <span class="token string">'foreignField'</span><span class="token punctuation">:</span> <span class="token string">'_id'</span><span class="token punctuation">,</span>
    <span class="token string">'as'</span><span class="token punctuation">:</span> <span class="token string">'author'</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">'$unwind'</span><span class="token punctuation">:</span> <span class="token string">'$author'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">'$match'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'author.age'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'$lte'</span><span class="token punctuation">:</span> <span class="token number">19</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token string">'$lookup'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'from'</span><span class="token punctuation">:</span> <span class="token string">'comments'</span><span class="token punctuation">,</span>
    <span class="token string">'localField'</span><span class="token punctuation">:</span> <span class="token string">'_id'</span><span class="token punctuation">,</span>
    <span class="token string">'foreignField'</span><span class="token punctuation">:</span> <span class="token string">'article_id'</span><span class="token punctuation">,</span>
    <span class="token string">'as'</span><span class="token punctuation">:</span> <span class="token string">'comments'</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div>
<p>이런 경우는 3번째에 등장하는 <code>$match</code> 스테이지에서 <code>author.age</code>를 조건으로 사용하기 위해 미리 <code>$lookup</code> 하지 않을 수 없기 때문에 <code>$lookup</code>의 순서를 뒤로 미뤄 성능 향상을 기대할 수는 없다.
RDBMS에서는 자주 등장할 수 있는 쿠에리지만 <code>JOIN</code>되는 필드에 외래키, 인덱스가 적절히 걸려있다면 심각한 성능 저하가 발생하지는 않는다.</p>
<p><code>$lookup</code>을 최적화 하는 과정은 아직도 진행단계고 좀 긴 넋두리가 필요하므로 다음기회(가 있다면)에 소개하기로 한다.</p>
<h2 id="facet-퍼포먼스-문제"><a href="#facet-%ED%8D%BC%ED%8F%AC%EB%A8%BC%EC%8A%A4-%EB%AC%B8%EC%A0%9C" aria-hidden="true" tab-index="-1"><span class="icon icon-link"></span></a>$facet 퍼포먼스 문제</h2>
<p>두번째로 발견한 성능저하의 문제는, <code>$facet</code>의 퍼포먼스가 너무 좋지 않다. 하나의 pipeline을 둘로 나누어 병렬로 실행한다 라는 아이디어는 깜찍하고 좋았지만,
실제 실행 단계에서 나뉘기 전 스테이지까지의 결과를 재활용하기는 하는건지 의심스러울 정도로 <code>$facet</code>가 등장하는 aggregation은 성능이 항상 좋지 않았다.</p>
<p>또한, 문서 수 및 문서 목록을 하나의 파이프라인에서 모두 연산해 올 때 까지 대기해야 하므로 replicaSet의 분산 처리 도움을 별로 받지 못한다.</p>
<p>nodejs 에서는 mongoos 라이브러리의 구현을 조금 참조하여 <code>$facet</code>를 쓰지 않고 두번에 나누어 (동시에)실행하도록 paged 헬퍼를 수정했다.</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-js"><code><span class="token doc-comment comment">/**
 * 몽고디비 aggregation 을 페이징한다
 * <span class="token keyword">@async</span>
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Collection<span class="token punctuation">}</span></span> <span class="token parameter">collection</span> 몽고디비 컬렉션
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>object <span class="token operator">|</span> object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span> <span class="token parameter">condition</span> query 또는 aggregation 파이프라인
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>object<span class="token punctuation">}</span></span> <span class="token optional-parameter"><span class="token punctuation">[</span><span class="token parameter">options</span><span class="token punctuation">]</span></span>
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>number<span class="token punctuation">}</span></span> [options.page = 1] 페이지번호
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>number<span class="token punctuation">}</span></span> [options.pageSize = 10] 페이지당 문서 갯수
 * <span class="token keyword">@returns</span> <span class="token class-name"><span class="token punctuation">{</span>Promise<span class="token punctuation">&lt;</span>PagedCursor<span class="token punctuation">></span><span class="token punctuation">}</span></span>
 */</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function">paged</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">collection<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> <span class="token punctuation">{</span>page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> pipeline <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token known-class-name class-name">Array</span><span class="token punctuation">.</span><span class="token method function property-access">isArray</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// aggregation pipeline인 경우</span>
    pipeline<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> condition<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">// query only인 경우</span>
    pipeline<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>$match<span class="token operator">:</span> condition<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> countPipeline <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>pipeline<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token parameter">elm</span> <span class="token arrow operator">=></span> <span class="token operator">!</span>elm<span class="token punctuation">[</span><span class="token string">'$sort'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  countPipeline<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> $group<span class="token operator">:</span> <span class="token punctuation">{</span> _id<span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span> count<span class="token operator">:</span> <span class="token punctuation">{</span> $sum<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> pagedPipeline <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>pipeline<span class="token punctuation">]</span>
  pagedPipeline<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>$skip<span class="token operator">:</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">}</span><span class="token punctuation">)</span>
  pagedPipeline<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>$limit<span class="token operator">:</span> pageSize<span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    collection<span class="token punctuation">.</span><span class="token method function property-access">aggregate</span><span class="token punctuation">(</span>pagedPipeline<span class="token punctuation">,</span> <span class="token punctuation">{</span>allowDiskUse<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    collection<span class="token punctuation">.</span><span class="token method function property-access">aggregate</span><span class="token punctuation">(</span>countPipeline<span class="token punctuation">,</span> <span class="token punctuation">{</span>allowDiskUse<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>items<span class="token punctuation">,</span> countResult<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> total <span class="token operator">=</span> countResult<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> countResult<span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">count</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token keyword">const</span> totalPages <span class="token operator">=</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">ceil</span><span class="token punctuation">(</span>total <span class="token operator">/</span> pageSize<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      page<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> total<span class="token punctuation">,</span> totalPages<span class="token punctuation">,</span> items
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2 id="lazy-loading-전략"><a href="#lazy-loading-%EC%A0%84%EB%9E%B5" aria-hidden="true" tab-index="-1"><span class="icon icon-link"></span></a>lazy loading 전략</h2>
<p><code>$lookup</code> 스테이지의 목적이 단순히 다른 컬렉션의 일부 정보를 가져와 도큐먼트의 속성에 끼워넣어 주기를 바라기만 하는 경우라면 굳이 <code>$lookup</code> 스테이지를 활용하지 않고,
연관 도큐먼트를 별도로 조회한 다음 결과 목록에 확장시켜주어도 성능엔 큰 차이가 없다. (orm 의 eager/lazy loading 전략과 비슷)</p>
<p>사실은 원시 컬렉션의 외래키를 수집하여 어플리케이션 서버에서 다시 두번째 쿠에리를 만들어 DB서버에 전송하는 것을 비효율적이지만, 어플리케이션 서버와 DB서버의 네트워크 거리가 충분히 가까운 경우라면
<code>$lookup</code> 을 이용하여 몽고디비 내에서 연관 컬렉션을 조회하는 것과 거의 성능의 차이가 없고 어떤 경우는 더 좋은 경우도 있었다.</p>
<p>이런 역할을 하는 <code>lookup()</code> 헬퍼를 nodejs 버전으로 작성했다. 파라메터 종류는 <code>$lookup($aggregation)</code> 과 거의 같다.</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-js"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>DataBase<span class="token punctuation">}</span></span> <span class="token parameter">db</span>
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>object<span class="token punctuation">}</span></span> <span class="token parameter">information</span>
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>string<span class="token punctuation">}</span></span> <span class="token parameter">information<span class="token punctuation">.</span>from</span> 참조할 컬렉션 이름
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>string<span class="token punctuation">}</span></span> <span class="token parameter">information<span class="token punctuation">.</span>localField</span> 외래키에 대응할 로컬 키 이름
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>string<span class="token punctuation">}</span></span> <span class="token parameter">information<span class="token punctuation">.</span>foreignField</span> 왜래키 이름
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>string<span class="token punctuation">}</span></span> <span class="token parameter">information<span class="token punctuation">.</span>as</span> 참조된 왜래 컬렉션의 아이템을 매핑할 속성명
 * <span class="token keyword">@returns</span> <span class="token class-name"><span class="token punctuation">{</span>lookup~filler<span class="token punctuation">}</span></span>
 */</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function">lookup</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">db<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module">from</span><span class="token punctuation">,</span> localField<span class="token punctuation">,</span> foreignField<span class="token punctuation">,</span> <span class="token keyword module">as</span><span class="token punctuation">,</span> project <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * <span class="token keyword">@function</span> lookup~filler
   * <span class="token keyword">@returns</span> <span class="token class-name"><span class="token punctuation">{</span>PagedCursor<span class="token punctuation">}</span></span>
   */</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>items<span class="token punctuation">,</span> <span class="token spread operator">...</span>rest<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ids <span class="token operator">=</span> items<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token arrow operator">=></span> item<span class="token punctuation">[</span>localField<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token method function property-access">collection</span><span class="token punctuation">(</span><span class="token keyword module">from</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token punctuation">[</span>foreignField<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{</span>$<span class="token keyword">in</span><span class="token operator">:</span> ids<span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>$project<span class="token operator">:</span> project<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">props</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> propIds <span class="token operator">=</span> props<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">prop</span> <span class="token arrow operator">=></span> <span class="token string">''</span> <span class="token operator">+</span> prop<span class="token punctuation">[</span>foreignField<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>items<span class="token operator">:</span> items<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> propIds<span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span><span class="token string">''</span> <span class="token operator">+</span> item<span class="token punctuation">[</span>localField<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          item<span class="token punctuation">[</span><span class="token keyword module">as</span><span class="token punctuation">]</span> <span class="token operator">=</span> props<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> item
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token spread operator">...</span>rest<span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 여러개의 lookup을 동시에 수행한다
 */</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function">lookupAll</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">db<span class="token punctuation">,</span> <span class="token spread operator">...</span>desires</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>items<span class="token punctuation">,</span> <span class="token spread operator">...</span>rest<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">all</span><span class="token punctuation">(</span>desires<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">desire</span> <span class="token arrow operator">=></span> <span class="token function">lookup</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> desire<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>items<span class="token punctuation">,</span> <span class="token spread operator">...</span>rest<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>r<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>이렇게 사용한다.</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-js"><code><span class="token function">paged</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token method function property-access">collection</span><span class="token punctuation">(</span><span class="token string">'galaxy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>$match<span class="token operator">:</span> <span class="token punctuation">{</span>answer<span class="token operator">:</span> <span class="token number">42</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>page<span class="token punctuation">,</span> pageSize<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token function">lookup</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token keyword module">from</span><span class="token operator">:</span> <span class="token string">'hitchiker'</span><span class="token punctuation">,</span>
    localField<span class="token operator">:</span> <span class="token string">'_id'</span><span class="token punctuation">,</span>
    foreignField<span class="token operator">:</span> <span class="token string">'galaxy_id'</span><span class="token punctuation">,</span>
    <span class="token keyword module">as</span><span class="token operator">:</span> <span class="token string">'hitchhikers'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>요즘은 대부분 그렇지 않지만 RDBMS의 <code>LIMIT n, m</code>  만으로 문서의 페이징을 하는 경우에도 100만건 정도의 문서에서는 꽤 성능이 나오지 않았던 과거를 떠올려본다.</p>
<p>프로그램을 짜다 보면 데이터 설계 당시의 의도와는 다르게 복잡한 조회 조건이나 외래 키 없는 다른 데이터 컬렉션을 참조하고 싶다는 요구를 종종 받게 된다.
이때마다 인덱스나 외래키를 추가할 수는 없는 일이다. 결국 상황에 맞는 정교한 pipeline을 매번 잘 짜거나, 언어레벨의 서포트로 극뽁하는 수 밖에..</p>
<p>조금은 무책임한 <code>$lookup</code>과 <code>$facet</code>의 퍼포먼스 문제로 약간은 당황했지만, mongodb만의 문제는 아닌 것으로.. 계속해서 발전하는 몽고디비가 되기를</p>
<div class="footnotes">
<hr>
<ol>
<li id="fn-1">실제로 일반적인 경우엔 나쁘지 않은 성능으로 페이징 하는데 문제가 없다<a href="#fnref-1" class="footnote-backref">↩</a></li>
</ol>
</div></div> <!----></article></div> <footer class="bg-gray-200"><div class="mx-auto container py-8">
      footer
    </div></footer></div></div></div><script>window.__NUXT__=function(e,p,a,t,l,s,y,r,c,u,v,n,i,o,g,d,h,m,N,f,B,A,k,E,$,_,C,b,x,D,P,z,F,S,j,w,I,M,q,R,L,T,H,O,U,Z,G,J,Q,X,K,V,W,Y,ee,pe,ae,te,le,se,ye,re,ce,ue,ve,ne,ie,oe,ge,de,he,me,Ne,fe,Be,Ae,ke,Ee,$e,_e,Ce,be,xe,De,Pe,ze,Fe,Se,je,we,Ie,Me,qe,Re,Le,Te,He,Oe,Ue,Ze,Ge,Je,Qe,Xe,Ke,Ve,We,Ye,ep,pp,ap,tp,lp,sp,yp,rp,cp,up,vp,np,ip,op,gp,dp,hp,mp,Np,fp,Bp,Ap,kp,Ep,$p,_p){return{layout:"default",data:[{path:"article/2020-06/20-mongodb-performance-on-paging",article:{title:"몽고디비 페이징과 룩업 성능",description:"몽고디비 aggregation을 페이징 할 때 성능 문제 해결기\n",toc:[{id:Ye,depth:2,text:ep},{id:pp,depth:2,text:ap},{id:tp,depth:2,text:lp}],body:{type:"root",children:[{type:p,tag:$,props:{},children:[{type:e,value:"몽고디비는 도큐먼트DB 특성상 기존 RDBMS와는 데이터를 다루는 철학에 차이가 조금 있다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"이번에 회사 프로덕트를 만들면서 여러 컬렉션을 참조하는 목록을 페이징하는 쿠에리에서 심각하게 성능저하가 일어나는 것을 발견하여 이를 해결하는 과정을 소개한다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"우선, 페이징을 구현하기 위해서는 전체 컬렉션 또는 커서의 일부분만 잘라내어 fetch 해줄 방법이 필요하다.\n몽고디비에는 "},{type:p,tag:m,props:{},children:[{type:e,value:".skip()"}]},{type:e,value:" 과 "},{type:p,tag:m,props:{},children:[{type:e,value:".limit()"}]},{type:e,value:" 체인메소드를 기본 제공하기 때문에 이 부분에는 문제가 없다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"하지만 총 몇 page가 존재하는지(또는 이전/다음 페이지가 존재하는지)를 알기 위해서는 커서의 총 도큐먼트 수를 알아내야 할 필요가 있다.\n과거 3.x 이전 버전에서는 우선 cursor를 만든다음 클론하여 하나는 도큐먼트 수를 세는데, 하나는 커서의 일부를 잘라내는데 사용했었다."}]},{type:e,value:i},{type:p,tag:H,props:{className:[O]},children:[{type:p,tag:U,props:{className:[Z,re]},children:[{type:p,tag:m,props:{},children:[{type:e,value:"mongo"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:w}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"var"}]},{type:e,value:" cursor "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:" db"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,B]},children:[{type:e,value:"contents"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"find"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:"query"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:sp},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:w}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"var"}]},{type:e,value:yp},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:rp},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"clone"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"count"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:sp},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:w}]},{type:e,value:rp},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"skip"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:ce},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:G}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:I}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:"*"}]},{type:e,value:" itemPerPage"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"limit"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:"itemPerPage"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:i}]}]}]},{type:e,value:i},{type:p,tag:"h2",props:{id:Ye},children:[{type:p,tag:Y,props:{href:"#%ED%8E%98%EC%9D%B4%EC%A7%95%ED%95%A0-%EB%AC%B8%EC%84%9C-%EC%A0%84%EC%B2%B4%EC%9D%98-%EA%B0%AF%EC%88%98-%EA%B0%80%EC%A0%B8%EC%98%A4%EA%B8%B0",ariaHidden:ee,tabIndex:-1},children:[{type:p,tag:a,props:{className:[Be,Ae]},children:[]}]},{type:e,value:ep}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"4.x 부터는 "},{type:p,tag:m,props:{},children:[{type:e,value:cp}]},{type:e,value:" 메소드 사용을 지양하고 "},{type:p,tag:m,props:{},children:[{type:e,value:"collection.countDocuments(query)"}]},{type:e,value:" 또는 "},{type:p,tag:m,props:{},children:[{type:e,value:"collection.estimatedDocumentCount(query)"}]},{type:e,value:" 를 대신 사용할 것을 권장할 뿐 아니라, 일부 드라이버에서는 이미 "},{type:p,tag:m,props:{},children:[{type:e,value:cp}]},{type:e,value:" 메소드가 deprecate 되어있다. 여기에는 함정이 숨어있는데, 단순 "},{type:p,tag:m,props:{},children:[{type:e,value:"collection.find()"}]},{type:e,value:"가 아닌 aggregation의 경우에는 해당되지 않는다는 점이다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"aggregation을 페이징 하려면 "},{type:p,tag:m,props:{},children:[{type:e,value:"AggregationPipeline.count()"}]},{type:e,value:" 를 조회하는 대신 pipeline의 일정 단계 이후 스테이지를 분기하여 각각 "},{type:p,tag:m,props:{},children:[{type:e,value:"도큐먼트 수"}]},{type:e,value:" 및 "},{type:p,tag:m,props:{},children:[{type:e,value:"페이징된 커서"}]},{type:e,value:" 를 얻는데 사용해야 한다.\n스테이지를 여러개로 분리하는데는 "},{type:p,tag:m,props:{},children:[{type:e,value:pe}]},{type:e,value:" 스테이지를 활용하면 한번의 오퍼레이션으로 두가지 정보를 한꺼번에 가져올 수 있다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"(여기서부터는 헬퍼 코드를 작성했기 때문에, mongo shell 대신 각종 언어 드라이버 기준으로...)"}]},{type:e,value:i},{type:p,tag:H,props:{className:[O]},children:[{type:p,tag:U,props:{className:[Z,ke]},children:[{type:p,tag:m,props:{},children:[{type:p,tag:a,props:{className:[t,"decorator","annotation",l]},children:[{type:e,value:"@dataclass"}]},{type:e,value:i},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"class"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:e,value:"PagedAggregation"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,M]},children:[{type:e,value:Ee}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:"\n\n    page"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,M]},children:[{type:e,value:"int"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:I}]},{type:e,value:"\n    page_size"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,M]},children:[{type:e,value:"int"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:"10"}]},{type:e,value:"\n    total"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,M]},children:[{type:e,value:"int"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:"0"}]},{type:e,value:"\n    items"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:" List"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,M]},children:[{type:e,value:$e}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:" field"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:"default_factory"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:p,tag:a,props:{className:[t,M]},children:[{type:e,value:"list"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:up},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"def"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,N]},children:[{type:e,value:"__iter__"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:_e},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:G}]},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:w}]},{type:e,value:" Generator"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,M]},children:[{type:e,value:$e}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:S},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"yield"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:ae}]},{type:e,value:K},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:"items\n\n    "},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"def"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,N]},children:[{type:e,value:"__json__"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:_e},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:G}]},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:w}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,M]},children:[{type:e,value:$e}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:S},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:q}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:R},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'page'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:K},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:Ce},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:R},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'pageSize'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:K},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:be},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:R},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:xe}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:K},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:"total"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:R},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'totalPages'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:" math"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:"ceil"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:_e},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:"total "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:"/"}]},{type:e,value:K},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:be},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:R},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:De}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:K},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:"items\n        "},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:"\n\n"},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"def"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,N]},children:[{type:e,value:ue}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:V},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:" Collection"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:Pe},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:" List"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:ze},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:I}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:ve},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:"10"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:G}]},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:w}]},{type:e,value:vp},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,"triple-quoted-string",v]},children:[{type:e,value:'"""\n    generates an aggregation facet pipeline, then fetch\n    """'}]},{type:e,value:"\n    pager "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'$facet'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:S},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:np}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:e,value:R},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'$count'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:xe}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:R},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'$addFields'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'page'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:ze},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:S},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:S},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:De}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:e,value:R},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'$skip'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:ce},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:G}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:I}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:"*"}]},{type:e,value:ve},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:R},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'$limit'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:ve},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:S},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:"\n\n    paged_pipeline "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:Pe},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:e,value:"\n    paged_pipeline"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:"append"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:"pager"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:"\n    doc "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,M]},children:[{type:e,value:"next"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:V},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:Fe},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:"paged_pipeline"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:up},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:q}]},{type:e,value:vp},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:"\n        page"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:Ce},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:"\n        page_size"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:be},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:"\n        total"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:"doc"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:np}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:"0"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:xe}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:"\n        items"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:"doc"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:De}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:i}]}]}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"구글링과 스택넘침질로 얻은 각종 스킬들을 조합하여 나름 꽤 심플하고 합리적으로 aggregate의 페이징을 정리한 듯 했다"},{type:p,tag:"sup",props:{id:"fnref-1"},children:[{type:p,tag:Y,props:{href:"#fn-1",className:["footnote-ref"]},children:[{type:e,value:I}]}]},{type:e,value:".\n하지만 문서 수가 수십만을 넘기 시작하면서, 파이프라인에서 다른 컬렉션을 $lookup 하는 빈도가 늘어나면서 성능이 심각할 정도로 나빠지기 시작했다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:'개인적으로는 실행 계획(explain)을 눈으로 짐작하기 쉽지 않은 SQL보다 각 단계에서 할 일을 순차적으로 명시하는 aggregation pipeline 쪽이 훨씬 낫다고 생각했었다.\n물론 그 사실에는 변함이 없지만, 데이터를 "관계"로 바라보는 RDBMS와 다르게 "도큐먼트"로 바라보는 몽고디비의 철학에서 내가 원하는 "결과"만을 목적으로 파이프라인을 짜다보면 자신이 놓은 함정에 걸리게 되는 경우가 생긴다.'}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"위에 작성한 "},{type:p,tag:m,props:{},children:[{type:e,value:ue}]},{type:e,value:" 헬퍼를 이용하여 평균 20여개의 코멘트가 달린 100만건의 블로그 글 목록에서 내가 작성한 글의 일부 페이지를 가져오려고 한다면,"}]},{type:e,value:i},{type:p,tag:H,props:{className:[O]},children:[{type:p,tag:U,props:{className:[Z,ke]},children:[{type:p,tag:m,props:{},children:[{type:e,value:ip},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:op}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:gp}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:" me\n  "},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:Se}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:je}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:ne}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:we}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:ie}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:Ie}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:dp}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:Me}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:ne}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:i},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:e,value:"\n\npaged"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:J},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:"articles"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:Pe},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:ze},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:"100"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:ve},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:"10"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:i}]}]}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"이런 식이 될 것이다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:p,tag:m,props:{},children:[{type:e,value:j}]},{type:e,value:" 스테이지가 "},{type:p,tag:m,props:{},children:[{type:e,value:"$skip"}]},{type:e,value:", "},{type:p,tag:m,props:{},children:[{type:e,value:qe}]},{type:e,value:" 스테이지보다 앞서 등장하기 때문에 10개의 도큐먼트를 얻기 전에 100만건 article 모두에 대한 comment 를 미리 lookup 하게 되어, 사실상 문서마다 20개의 댓글을 포함하여 총 2000만개의 도큐먼트를 조회한 후 그중 일부를 가져오게 된다.\naggregation pipeline은 메모리상에서 최대 100MB만 사용할 수 있는 제약사항이 있기 때문에 스테이지의 일부 단계에서 문서 갯수가 많거나 메모리를 초과할 것으로 예상된다면 미리 "},{type:p,tag:m,props:{},children:[{type:e,value:Re}]},{type:e,value:" 옵션을 활성화 시켜 두지 않았다면 최종 10개 문서(x20개 댓글)를 가져오기 전에 이미 메모리 부족 에러를 만날 가능성도 있다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"위 예시의 경우는 페이징을 마치 RDBMS의 "},{type:p,tag:m,props:{},children:[{type:e,value:hp}]},{type:e,value:" 으로 다루듯 마지막 단계에만 페이징을 위한 스테이지를 추가하는 경우를 보여주는 예시로, 몽고디비에서 쉽게 저지를 수 있는 실수에 해당한다.\n"},{type:p,tag:m,props:{},children:[{type:e,value:j}]},{type:e,value:" 스테이지를 직접 "},{type:p,tag:m,props:{},children:[{type:e,value:qe}]},{type:e,value:" 스테이지 다음으로 옮겨두면 극적으로 성능 향상을 기대할 수 있다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:p,tag:m,props:{},children:[{type:e,value:j}]},{type:e,value:"된 외래 도큐먼트의 속성을 "},{type:p,tag:m,props:{},children:[{type:e,value:oe}]},{type:e,value:" 스테이지에서 활용하고자 하는 경우엔 이야기가 달라진다."}]},{type:e,value:i},{type:p,tag:"blockquote",props:{},children:[{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"19세 미만 미성년자가 작성한 글과 댓글을 가져오려는 경우.."}]},{type:e,value:i}]},{type:e,value:i},{type:p,tag:H,props:{className:[O]},children:[{type:p,tag:U,props:{className:[Z,ke]},children:[{type:p,tag:m,props:{},children:[{type:e,value:ip},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:Se}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:je}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:mp}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:we}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:gp}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:Ie}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:ie}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:Me}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:mp}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'$unwind'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'$author'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:op}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'author.age'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'$lte'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:"19"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:Se}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:je}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:ne}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:we}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:ie}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:Ie}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:dp}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:Me}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:ne}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:i},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:e,value:i}]}]}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"이런 경우는 3번째에 등장하는 "},{type:p,tag:m,props:{},children:[{type:e,value:oe}]},{type:e,value:" 스테이지에서 "},{type:p,tag:m,props:{},children:[{type:e,value:"author.age"}]},{type:e,value:"를 조건으로 사용하기 위해 미리 "},{type:p,tag:m,props:{},children:[{type:e,value:j}]},{type:e,value:" 하지 않을 수 없기 때문에 "},{type:p,tag:m,props:{},children:[{type:e,value:j}]},{type:e,value:"의 순서를 뒤로 미뤄 성능 향상을 기대할 수는 없다.\nRDBMS에서는 자주 등장할 수 있는 쿠에리지만 "},{type:p,tag:m,props:{},children:[{type:e,value:"JOIN"}]},{type:e,value:"되는 필드에 외래키, 인덱스가 적절히 걸려있다면 심각한 성능 저하가 발생하지는 않는다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:p,tag:m,props:{},children:[{type:e,value:j}]},{type:e,value:"을 최적화 하는 과정은 아직도 진행단계고 좀 긴 넋두리가 필요하므로 다음기회(가 있다면)에 소개하기로 한다."}]},{type:e,value:i},{type:p,tag:"h2",props:{id:pp},children:[{type:p,tag:Y,props:{href:"#facet-%ED%8D%BC%ED%8F%AC%EB%A8%BC%EC%8A%A4-%EB%AC%B8%EC%A0%9C",ariaHidden:ee,tabIndex:-1},children:[{type:p,tag:a,props:{className:[Be,Ae]},children:[]}]},{type:e,value:ap}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"두번째로 발견한 성능저하의 문제는, "},{type:p,tag:m,props:{},children:[{type:e,value:pe}]},{type:e,value:"의 퍼포먼스가 너무 좋지 않다. 하나의 pipeline을 둘로 나누어 병렬로 실행한다 라는 아이디어는 깜찍하고 좋았지만,\n실제 실행 단계에서 나뉘기 전 스테이지까지의 결과를 재활용하기는 하는건지 의심스러울 정도로 "},{type:p,tag:m,props:{},children:[{type:e,value:pe}]},{type:e,value:"가 등장하는 aggregation은 성능이 항상 좋지 않았다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"또한, 문서 수 및 문서 목록을 하나의 파이프라인에서 모두 연산해 올 때 까지 대기해야 하므로 replicaSet의 분산 처리 도움을 별로 받지 못한다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"nodejs 에서는 mongoos 라이브러리의 구현을 조금 참조하여 "},{type:p,tag:m,props:{},children:[{type:e,value:pe}]},{type:e,value:"를 쓰지 않고 두번에 나누어 (동시에)실행하도록 paged 헬퍼를 수정했다."}]},{type:e,value:i},{type:p,tag:H,props:{className:[O]},children:[{type:p,tag:U,props:{className:[Z,re]},children:[{type:p,tag:m,props:{},children:[{type:p,tag:a,props:{className:[t,ge,W]},children:[{type:e,value:"/**\n * 몽고디비 aggregation 을 페이징한다\n * "},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"@async"}]},{type:e,value:de},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:F}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:"Collection"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:V}]},{type:e,value:" 몽고디비 컬렉션\n * "},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:F}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:"object "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:"|"}]},{type:e,value:" object"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:Np}]},{type:e,value:" query 또는 aggregation 파이프라인\n * "},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:F}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:Ee},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,"optional-parameter"]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:"options"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]}]},{type:e,value:de},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:F}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:x},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:" [options.page = 1] 페이지번호\n * "},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:F}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:x},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:" [options.pageSize = 10] 페이지당 문서 갯수\n * "},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:Le}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:Te},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:"<"}]},{type:e,value:fp},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:w}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:"\n */"}]},{type:e,value:i},{type:p,tag:a,props:{className:[t,d,L]},children:[{type:e,value:He}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:T}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,Oe,N]},children:[{type:e,value:ue}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:V},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:Ue},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:ce},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:I}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:" pageSize "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:"10"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,P,y]},children:[{type:e,value:z}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"let"}]},{type:e,value:" pipeline "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"if"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,he,D]},children:[{type:e,value:"Array"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"isArray"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:Np},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,W]},children:[{type:e,value:"// aggregation pipeline인 경우"}]},{type:e,value:Bp},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:te}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"apply"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:Ze},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:Ue},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"else"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:"  "},{type:p,tag:a,props:{className:[t,W]},children:[{type:e,value:"// query only인 경우"}]},{type:e,value:Bp},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:te}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:oe},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:Ue},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:Ge},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:T}]},{type:e,value:" countPipeline "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,Q,y]},children:[{type:e,value:X}]},{type:e,value:Ze},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"filter"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:"elm"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,P,y]},children:[{type:e,value:z}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:"!"}]},{type:e,value:"elm"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'$sort'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:"\n  countPipeline"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:te}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:" $group"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:" _id"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,d,"null","nil"]},children:[{type:e,value:"null"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:" count"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:" $sum"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:I}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:Ge},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:T}]},{type:e,value:" pagedPipeline "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,Q,y]},children:[{type:e,value:X}]},{type:e,value:Ze},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:e,value:Ap},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:te}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:"$skip"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:ce},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:G}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:I}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:"*"}]},{type:e,value:le},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:Ap},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:te}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:qe},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:le},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:Ge},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:q}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,he,D]},children:[{type:e,value:Te}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"all"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:e,value:kp},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:Fe}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:"pagedPipeline"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:Re},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,Ep]},children:[{type:e,value:ee}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:Je}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:kp},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:Fe}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:"countPipeline"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:Re},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,Ep]},children:[{type:e,value:ee}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:Je}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:me}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:e,value:se},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:Qe},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,P,y]},children:[{type:e,value:z}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:T}]},{type:e,value:yp},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:Qe},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,B]},children:[{type:e,value:"length"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:w}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:"0"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:"?"}]},{type:e,value:Qe},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"shift"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,B]},children:[{type:e,value:"count"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:"0"}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:T}]},{type:e,value:" totalPages "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,he,D]},children:[{type:e,value:"Math"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"ceil"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:"total "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:"/"}]},{type:e,value:le},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:q}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:"\n      page"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:le},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:" total"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:" totalPages"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:" items\n    "},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:i},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:i}]}]}]},{type:e,value:i},{type:p,tag:"h2",props:{id:tp},children:[{type:p,tag:Y,props:{href:"#lazy-loading-%EC%A0%84%EB%9E%B5",ariaHidden:ee,tabIndex:-1},children:[{type:p,tag:a,props:{className:[Be,Ae]},children:[]}]},{type:e,value:lp}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:p,tag:m,props:{},children:[{type:e,value:j}]},{type:e,value:" 스테이지의 목적이 단순히 다른 컬렉션의 일부 정보를 가져와 도큐먼트의 속성에 끼워넣어 주기를 바라기만 하는 경우라면 굳이 "},{type:p,tag:m,props:{},children:[{type:e,value:j}]},{type:e,value:" 스테이지를 활용하지 않고,\n연관 도큐먼트를 별도로 조회한 다음 결과 목록에 확장시켜주어도 성능엔 큰 차이가 없다. (orm 의 eager/lazy loading 전략과 비슷)"}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"사실은 원시 컬렉션의 외래키를 수집하여 어플리케이션 서버에서 다시 두번째 쿠에리를 만들어 DB서버에 전송하는 것을 비효율적이지만, 어플리케이션 서버와 DB서버의 네트워크 거리가 충분히 가까운 경우라면\n"},{type:p,tag:m,props:{},children:[{type:e,value:j}]},{type:e,value:" 을 이용하여 몽고디비 내에서 연관 컬렉션을 조회하는 것과 거의 성능의 차이가 없고 어떤 경우는 더 좋은 경우도 있었다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"이런 역할을 하는 "},{type:p,tag:m,props:{},children:[{type:e,value:"lookup()"}]},{type:e,value:" 헬퍼를 nodejs 버전으로 작성했다. 파라메터 종류는 "},{type:p,tag:m,props:{},children:[{type:e,value:"$lookup($aggregation)"}]},{type:e,value:" 과 거의 같다."}]},{type:e,value:i},{type:p,tag:H,props:{className:[O]},children:[{type:p,tag:U,props:{className:[Z,re]},children:[{type:p,tag:m,props:{},children:[{type:p,tag:a,props:{className:[t,ge,W]},children:[{type:e,value:"/**\n * "},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:F}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:"DataBase"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:J}]},{type:e,value:de},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:F}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:Ee},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:ye}]},{type:e,value:de},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:F}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:v},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:ye},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:ae}]},{type:e,value:" 참조할 컬렉션 이름\n * "},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:F}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:v},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:ye},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:Xe}]},{type:e,value:" 외래키에 대응할 로컬 키 이름\n * "},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:F}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:v},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:ye},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:Ke}]},{type:e,value:" 왜래키 이름\n * "},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:F}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:v},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:ye},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:e,value:"as"}]},{type:e,value:" 참조된 왜래 컬렉션의 아이템을 매핑할 속성명\n * "},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:Le}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:"lookup~filler"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:"\n */"}]},{type:e,value:i},{type:p,tag:a,props:{className:[t,d,L]},children:[{type:e,value:He}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:T}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,Oe,N]},children:[{type:e,value:Ve}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:J},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,d,L]},children:[{type:e,value:ae}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:" localField"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:" foreignField"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,d,L]},children:[{type:e,value:"as"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:" project "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,P,y]},children:[{type:e,value:z}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,ge,W]},children:[{type:e,value:"/**\n   * "},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"@function"}]},{type:e,value:" lookup~filler\n   * "},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:Le}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,D]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:fp},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:e,value:"\n   */"}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:q}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:se},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,Q,y]},children:[{type:e,value:X}]},{type:e,value:Ne},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,P,y]},children:[{type:e,value:z}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:T}]},{type:e,value:" ids "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:" items"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:fe}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:"item"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,P,y]},children:[{type:e,value:z}]},{type:e,value:" item"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:e,value:Xe},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:q}]},{type:e,value:" db"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:V}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,d,L]},children:[{type:e,value:ae}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"find"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:We},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:e,value:Ke},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:"$"},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"in"}]},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:" ids"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:"$project"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:" project"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:Je}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:me}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:"props"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,P,y]},children:[{type:e,value:z}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:We},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:T}]},{type:e,value:" propIds "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:" props"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:fe}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:"prop"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,P,y]},children:[{type:e,value:z}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"''"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:"+"}]},{type:e,value:" prop"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:e,value:Ke},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:We},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:q}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:se},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:" items"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:fe}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:"item"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,P,y]},children:[{type:e,value:z}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:S},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"let"}]},{type:e,value:" index "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:" propIds"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"indexOf"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"''"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:"+"}]},{type:e,value:" item"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:e,value:Xe},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:S},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:"if"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:"index "},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:w}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:G}]},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:I}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:"\n          item"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,d,L]},children:[{type:e,value:"as"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:" props"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:e,value:"index"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:e,value:S},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:S},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:q}]},{type:e,value:" item\n      "},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,Q,y]},children:[{type:e,value:X}]},{type:e,value:Ne},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:i},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:"\n\n"},{type:p,tag:a,props:{className:[t,ge,W]},children:[{type:e,value:"/**\n * 여러개의 lookup을 동시에 수행한다\n */"}]},{type:e,value:i},{type:p,tag:a,props:{className:[t,d,L]},children:[{type:e,value:He}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:T}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,Oe,N]},children:[{type:e,value:"lookupAll"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:f}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:J},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,Q,y]},children:[{type:e,value:X}]},{type:e,value:$p}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,P,y]},children:[{type:e,value:z}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,d]},children:[{type:e,value:q}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:se},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,Q,y]},children:[{type:e,value:X}]},{type:e,value:Ne},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,P,y]},children:[{type:e,value:z}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,he,D]},children:[{type:e,value:Te}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:"all"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:$p},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:fe}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:e,value:"desire"}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,P,y]},children:[{type:e,value:z}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,N]},children:[{type:e,value:Ve}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:J},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:" desire"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:se},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,Q,y]},children:[{type:e,value:X}]},{type:e,value:Ne},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:me}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,b]},children:[{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:e,value:"r"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,P,y]},children:[{type:e,value:z}]},{type:e,value:" r"},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:i},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:e,value:i}]}]}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"이렇게 사용한다."}]},{type:e,value:i},{type:p,tag:H,props:{className:[O]},children:[{type:p,tag:U,props:{className:[Z,re]},children:[{type:p,tag:m,props:{},children:[{type:p,tag:a,props:{className:[t,N]},children:[{type:e,value:ue}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:J},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:V}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'galaxy'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:k}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:oe},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:"answer"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,x]},children:[{type:e,value:"42"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:E}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:Ce},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:le},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:h}]},{type:p,tag:a,props:{className:[t,A,N,B]},children:[{type:e,value:me}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:p,tag:a,props:{className:[t,N]},children:[{type:e,value:Ve}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:o}]},{type:e,value:J},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:r}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,d,L]},children:[{type:e,value:ae}]},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'hitchiker'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:"\n    localField"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:ie}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:"\n    foreignField"},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'galaxy_id'"}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:n}]},{type:e,value:_},{type:p,tag:a,props:{className:[t,d,L]},children:[{type:e,value:"as"}]},{type:p,tag:a,props:{className:[t,y]},children:[{type:e,value:u}]},{type:e,value:s},{type:p,tag:a,props:{className:[t,v]},children:[{type:e,value:"'hitchhikers'"}]},{type:e,value:C},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:c}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:p,tag:a,props:{className:[t,l]},children:[{type:e,value:g}]},{type:e,value:i}]}]}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"요즘은 대부분 그렇지 않지만 RDBMS의 "},{type:p,tag:m,props:{},children:[{type:e,value:hp}]},{type:e,value:"  만으로 문서의 페이징을 하는 경우에도 100만건 정도의 문서에서는 꽤 성능이 나오지 않았던 과거를 떠올려본다."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"프로그램을 짜다 보면 데이터 설계 당시의 의도와는 다르게 복잡한 조회 조건이나 외래 키 없는 다른 데이터 컬렉션을 참조하고 싶다는 요구를 종종 받게 된다.\n이때마다 인덱스나 외래키를 추가할 수는 없는 일이다. 결국 상황에 맞는 정교한 pipeline을 매번 잘 짜거나, 언어레벨의 서포트로 극뽁하는 수 밖에.."}]},{type:e,value:i},{type:p,tag:$,props:{},children:[{type:e,value:"조금은 무책임한 "},{type:p,tag:m,props:{},children:[{type:e,value:j}]},{type:e,value:"과 "},{type:p,tag:m,props:{},children:[{type:e,value:pe}]},{type:e,value:"의 퍼포먼스 문제로 약간은 당황했지만, mongodb만의 문제는 아닌 것으로.. 계속해서 발전하는 몽고디비가 되기를"}]},{type:e,value:i},{type:p,tag:H,props:{className:["footnotes"]},children:[{type:e,value:i},{type:p,tag:"hr",props:{},children:[]},{type:e,value:i},{type:p,tag:"ol",props:{},children:[{type:e,value:i},{type:p,tag:"li",props:{id:"fn-1"},children:[{type:e,value:"실제로 일반적인 경우엔 나쁘지 않은 성능으로 페이징 하는데 문제가 없다"},{type:p,tag:Y,props:{href:"#fnref-1",className:["footnote-backref"]},children:[{type:e,value:"↩"}]}]},{type:e,value:i}]},{type:e,value:i}]}]},dir:"/article/2020-06",path:_p,extension:".md",slug:"20-mongodb-performance-on-paging",createdAt:"2020-08-11T19:04:34.874Z",updatedAt:"2020-08-11T19:03:57.000Z"}}],fetch:[],error:null,serverRendered:!0,routePath:_p,config:{}}}("text","element","span","token","punctuation"," ","operator","{","}",":","string",",","\n","(",")","keyword",".","code","function","=","property-access","method","[","]","p","\n    ","\n  ","parameter","number","class-name","arrow","=>","@param","\n        ","$lookup",">","1","builtin","return","\n            ","module","const","div","nuxt-content-highlight","pre","line-numbers","-","db","spread","..."," self","collection","comment","a","true","$facet","from","push"," pageSize","items","information","language-js","page ","paged"," page_size","'comments'","'_id'","$match","doc-comment","\n * ","known-class-name","then","rest","map","icon","icon-link","language-python","object","dict","self","page","page_size","'total'","'items'"," pipeline"," page","aggregate","'$lookup'","'from'","'localField'","'foreignField'","'as'","$limit","allowDiskUse","@returns","Promise","export","function-variable"," condition","pipeline","\n\n  ","toArray"," countResult","localField","foreignField","lookup","\n      ","페이징할-문서-전체의-갯수-가져오기","페이징할 문서 전체의 갯수 가져오기","facet-퍼포먼스-문제","$facet 퍼포먼스 문제","lazy-loading-전략","lazy loading 전략","\nmongo"," total "," cursor","cursor.count()","\n\n    "," PagedAggregation","'metadata'","pipeline ","'$match'","'author_id'","'article_id'","LIMIT n, m","'author'","condition","PagedCursor","\n    pipeline","\n  pagedPipeline","\n    collection","boolean","desires","/article/2020-06/20-mongodb-performance-on-paging")</script><script src="/_nuxt/runtime.343d384.js" defer></script><script src="/_nuxt/pages/article/_.ceebc4b.js" defer></script><script src="/_nuxt/node_modules/article.~article.index.a6ee544.js" defer></script><script src="/_nuxt/node_modules/commons.c46341a.js" defer></script><script src="/_nuxt/app.9cff7de.js" defer></script>
  </body>
</html>
